#!/usr/bin/env bash

set -ue
shopt -s nullglob

exists() { command -v "$1" >/dev/null 2>/dev/null; }

if [ $# != 2 ]; then
  printf >&2 "Usage: %s <SRC-EXT> <DST-EXT>\n" "$(basename "$0")"
  printf >&2 "Converts all files in the current directory from SRC-EXT to DST-EXT, using ffmpeg\n"
fi

src_ext="$1"
dst_ext="$2"

src_files=(*."$src_ext")

if exists parallel; then
  n_jobs=${N_JOBS:-$(nproc)}
  eachLine() { parallel -j "$n_jobs" "$@"; }
else
  printf >&2 "warning: parallel not found, using xargs (sequential)\n"
  eachLine() { xargs -I{} "$@"; }
fi

printf >&2 "Will convert (to %s):\n" "$dst_ext"
for f in "${src_files[@]}"; do
  printf >&2 "  %s\n" "$f"
done

printf >&2 "Confirm? [y/N] "
read -r answer

case "$answer" in
  y|Y)
    printf "%s\n" "${src_files[@]}" \
      | eachLine ffmpeg-convert {} "$dst_ext"
    ;;
  n|N)
    exit 1
    ;;
  *)
    printf >&2 "Invalid answer\n"
    exit 1
    ;;
esac
