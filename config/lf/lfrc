# -*- mode: sh; -*-
# vim: ft=conf fdm=marker foldmarker={{,}} sw=2

set shell bash
set shellopts '-ue'

set icons
set ignorecase
set mouse
# set hidden
# set drawbox

# configure preview and column widths
set previewer cat
set nopreview
set ratios 1:4

# commands
cmd new ${{
  set -ue

  while true; do
    printf >&2 "\b(f)ile or (d)ir => "
    read -r -n1 answer
    printf >&2 "\n"

    case "$answer" in
      f|d) break ;;
      ) exit ;;
      *) ;;
    esac
  done

  printf >&2 "filename => "
  read -r filename
  printf >&2 "\n"

  [ -z "$filename" ] && exit

  if [ -e "$filename" ]; then
    printf "Filename already exists.\n"
    read _
  else
    case "$answer" in
      f) touch "$filename" ;;
      d) mkdir "$filename" ;;
    esac

    if [ $? != 0 ]; then
      printf "Failed to create file.\n"
      read _
    fi
  fi
}}

cmd trash ${{
  set -ue

  IFS=$(printf '\n\t')
  printf "Selected files:\n"
  printf "  %s\n" $fx
  printf "Would you like to send them to the TRASH?\n"

  while true; do
    printf "(y)es or (n)o => "
    read -n1 answer
    printf "\n"

    case "$answer" in
      y) trash-put $fx; break ;;
      n) break ;;
      *) ;;
    esac

    if [ $? != 0 ]; then
      printf "Failed to move file(s) to trash.\n"
      read _
    fi
  done
}}
cmd delete ${{
  set -ue

  IFS=$(printf '\n\t')
  printf "Selected files:\n"
  printf "  %s\n" $fx
  printf "Would you like to PERMANENTLY DELETE them?\n"

  while true; do
    printf "(y)es or (n)o => "
    read -n1 answer
    printf "\n"

    case "$answer" in
      y) rm -rvf $fx; break ;;
      n) break ;;
      *) ;;
    esac

    if [ $? != 0 ]; then
      printf "Failed to permanently delete file(s).\n"
      read _
    fi
  done
}}

cmd ffmpeg-convert ${{
  printf >&2 "file to convert: %s\n" "$f"
  printf >&2 "target format => "
  read -r targetFormat
  printf >&2 "\n"

  ffmpeg-convert "$f" "$targetFormat"
}}

cmd vidir-rename ${{
  set -efu
  if [ -z "$fs" ]; then
    fd -d1 | vidir -
  else
    printf "%s" "$fs" | vidir -
  fi
}}

cmd vid-trim-small ${{ vid-trim-small "$f" }}; reload
cmd make-exec ${{ chmod +x "$f" }}; reload
cmd make-noexec ${{ chmod -x "$f" }}; reload
cmd move-here ${{ PROMPT_ON_ERROR=1 d.fileman-actions move-here "$fs" }}; unselect; reload
cmd copy-here ${{ PROMPT_ON_ERROR=1 d.fileman-actions copy-here "$fs" }}; unselect; reload
cmd extract ${{ PROMPT_ON_ERROR=1 d.fileman-actions extract "$f" }}
cmd flatten ${{ PROMPT_ON_ERROR=1 d.fileman-actions flatten "$f" }}

# command mappings
map . set hidden!
map n new
map <c-n> search-next
map x trash
map R vidir-rename
map v move-here
map p copy-here
map E extract
map P set preview!
map ~ cd ~
map <c-z> ${{ kill -STOP "$PPID" }}
map <c-l> reload; redraw
map C ffmpeg-convert

# Remember that sort keybindings are through `s`! There's a lotta 'em.

# TODO: custom ruler - https://github.com/gokcehan/lf/wiki/Ruler - don't make it _too_ fancy
